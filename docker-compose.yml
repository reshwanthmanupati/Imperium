version: "3.8"

services:
  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: imperium-mqtt
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mqtt-data:/mosquitto/data
      - mqtt-logs:/mosquitto/log
    restart: unless-stopped

  # Prometheus for Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: imperium-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    restart: unless-stopped

  # Grafana for Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: imperium-grafana
    ports:
      - "3000:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    restart: unless-stopped

  # IoT Node Simulators with Prometheus metrics
  # Each node exposes metrics on port 800X where X is the node number
  iot-node-1:
    build:
      context: .
      dockerfile: Dockerfile.iot-node
    container_name: imperium-iot-node-1
    environment:
      - NODE_ID=node-1
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    ports:
      - "8001:8001"
    depends_on:
      - mosquitto
    restart: unless-stopped

  iot-node-2:
    build:
      context: .
      dockerfile: Dockerfile.iot-node
    container_name: imperium-iot-node-2
    environment:
      - NODE_ID=node-2
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    ports:
      - "8002:8002"
    depends_on:
      - mosquitto
    restart: unless-stopped

  iot-node-3:
    build:
      context: .
      dockerfile: Dockerfile.iot-node
    container_name: imperium-iot-node-3
    environment:
      - NODE_ID=node-3
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    ports:
      - "8003:8003"
    depends_on:
      - mosquitto
    restart: unless-stopped

  iot-node-4:
    build:
      context: .
      dockerfile: Dockerfile.iot-node
    container_name: imperium-iot-node-4
    environment:
      - NODE_ID=node-4
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    ports:
      - "8004:8004"
    depends_on:
      - mosquitto
    restart: unless-stopped

  iot-node-5:
    build:
      context: .
      dockerfile: Dockerfile.iot-node
    container_name: imperium-iot-node-5
    environment:
      - NODE_ID=node-5
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    ports:
      - "8005:8005"
    depends_on:
      - mosquitto
    restart: unless-stopped

  iot-node-6:
    build:
      context: .
      dockerfile: Dockerfile.iot-node
    container_name: imperium-iot-node-6
    environment:
      - NODE_ID=node-6
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    ports:
      - "8006:8006"
    depends_on:
      - mosquitto
    restart: unless-stopped

  iot-node-7:
    build:
      context: .
      dockerfile: Dockerfile.iot-node
    container_name: imperium-iot-node-7
    environment:
      - NODE_ID=node-7
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    ports:
      - "8007:8007"
    depends_on:
      - mosquitto
    restart: unless-stopped

  iot-node-8:
    build:
      context: .
      dockerfile: Dockerfile.iot-node
    container_name: imperium-iot-node-8
    environment:
      - NODE_ID=node-8
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    ports:
      - "8008:8008"
    depends_on:
      - mosquitto
    restart: unless-stopped

  iot-node-9:
    build:
      context: .
      dockerfile: Dockerfile.iot-node
    container_name: imperium-iot-node-9
    environment:
      - NODE_ID=node-9
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    ports:
      - "8009:8009"
    depends_on:
      - mosquitto
    restart: unless-stopped

  iot-node-10:
    build:
      context: .
      dockerfile: Dockerfile.iot-node
    container_name: imperium-iot-node-10
    environment:
      - NODE_ID=node-10
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    ports:
      - "8010:8010"
    depends_on:
      - mosquitto
    restart: unless-stopped

volumes:
  mqtt-data:
  mqtt-logs:
  prometheus-data:
  grafana-data:
